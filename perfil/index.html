<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Perfil - ZELETAS HUB</title>
  <link rel="stylesheet" href="../assets/css/styles.css">
  <style>
    /* REUTILIZAMOS TUS VARIABLES ZELETAS */
    body { background-color: var(--bg); color: var(--text); min-height: 100vh; }
    .perfil-container { max-width: 1100px; margin: 0 auto; padding: 40px 20px; }

    /* CABECERA */
    .perfil-header { 
      background: var(--bg2); padding: 40px; border-radius: 20px; 
      text-align: center; border: 1px solid var(--border); box-shadow: var(--shadow);
      margin-bottom: 30px;
    }
    #userImg { width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--green); margin-bottom: 10px; }

    /* SECCIONES */
    .section-title-perfil { 
      color: var(--green); font-size: 1.4rem; margin: 40px 0 20px; 
      display: flex; align-items: center; gap: 10px;
    }
    .section-title-perfil::after { content: ""; flex: 1; height: 1px; background: var(--border); }

    /* GRID DASHBOARD */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 18px; }
    .dash-card { 
      background: var(--card); border: 1px solid var(--border); border-radius: 18px; 
      padding: 22px; text-decoration: none; transition: 0.25s; text-align: center;
    }
    .dash-card:hover { transform: translateY(-3px); border-color: var(--green2); box-shadow: 0 8px 20px rgba(0, 200, 83, 0.1); }
    .dash-card .icon { font-size: 2rem; margin-bottom: 10px; display: block; }

    /* LISTA DE AJUSTES (NUEVO) */
    .settings-list { background: var(--bg2); border-radius: 18px; border: 1px solid var(--border); overflow: hidden; }
    .setting-item { 
      padding: 18px 22px; display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.2s;
    }
    .setting-item:last-child { border-bottom: none; }
    .setting-item:hover { background: rgba(0, 200, 83, 0.05); }
    .setting-info h4 { color: var(--text); margin-bottom: 4px; }
    .setting-info p { color: var(--muted); font-size: 0.85rem; }

    /* BOTONES ACCI√ìN */
    .btn-action { 
      background: var(--bg); border: 1px solid var(--border); color: var(--green); 
      padding: 8px 16px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.85rem;
    }
    .btn-action:hover { background: var(--green); color: var(--bg); }
    .btn-danger { color: #ff5252; border-color: rgba(255, 82, 82, 0.3); }
    .btn-danger:hover { background: #ff5252; color: #fff; }

    #logoutBtn { margin-top: 40px; width: 100%; max-width: 300px; }
  </style>
</head>
<body>

<div class="perfil-container">
  <header class="perfil-header">
    <img id="userImg" src="https://via.placeholder.com/100" alt="Avatar">
    <h2 id="nombreUsuario">Cargando...</h2>
    <p id="emailUsuario" style="color:var(--muted)">...</p>
    <span class="badge">Cuenta Zeletas Hub</span>
  </header>

  <h3 class="section-title-perfil">Gesti√≥n de Actividad</h3>
  <div class="dashboard-grid">
    <a href="../mis-anuncios/" class="dash-card"><span class="icon">üß©</span><h3>Anuncios</h3><p>Vende tus art√≠culos</p></a>
    <a href="../mis-favoritos/" class="dash-card"><span class="icon">‚ù§Ô∏è</span><h3>Favoritos</h3><p>Tus guardados</p></a>
    <a href="../mis-pedidos/" class="dash-card"><span class="icon">üõí</span><h3>Pedidos</h3><p>Tus compras</p></a>
    <a href="../mis-servicios/" class="dash-card"><span class="icon">üõ†Ô∏è</span><h3>Servicios</h3><p>Gesti√≥n de obras</p></a>
  </div>

  <h3 class="section-title-perfil">Seguridad y Privacidad</h3>
  <div class="settings-list">
    <div class="setting-item">
      <div class="setting-info">
        <h4>Cambiar Contrase√±a</h4>
        <p>Recibir√°s un enlace seguro en tu email.</p>
      </div>
      <button class="btn-action" onclick="resetPassword()">Solicitar</button>
    </div>

    <div class="setting-item">
      <div class="setting-info">
        <h4>Datos de Google</h4>
        <p>Sincronizado con tu cuenta de Google.</p>
      </div>
      <button class="btn-action" disabled style="opacity:0.5">Vinculado</button>
    </div>

    <div class="setting-item">
      <div class="setting-info">
        <h4>Descargar mis Datos</h4>
        <p>Obt√©n una copia de tu historial en Zeletas.</p>
      </div>
      <button class="btn-action" onclick="alert('Generando archivo...')">Descargar</button>
    </div>

    <div class="setting-item">
      <div class="setting-info">
        <h4>Borrar Cuenta</h4>
        <p style="color:#ff8a8a">Esta acci√≥n es irreversible y eliminar√° todo.</p>
      </div>
      <button class="btn-action btn-danger" onclick="deleteAccount()">Borrar Cuenta</button>
    </div>
  </div>

  <div style="text-align:center;">
    <button id="logoutBtn" class="btn btn-secondary">Cerrar Sesi√≥n Segura</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const S_URL = "https://sbqpkfdcznulwpxlxiwu.supabase.co";
  const S_KEY = "sb_publishable_9dX-ESpW0YwCaFfDR0aMAg_9PLvO2oo";
  const supabaseClient = supabase.createClient(S_URL, S_KEY);

  async function cargarUsuario() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) {
      const user = session.user;
      document.getElementById('nombreUsuario').textContent = user.user_metadata?.full_name || "Usuario";
      document.getElementById('emailUsuario').textContent = user.email;
      if (user.user_metadata?.avatar_url) document.getElementById('userImg').src = user.user_metadata.avatar_url;
    } else {
      window.location.href = "../index.html";
    }
  }

  // FUNCI√ìN: Resetear contrase√±a v√≠a Supabase
  async function resetPassword() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    const email = session.user.email;
    const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
      redirectTo: 'https://zeletas.netlify.app/perfil/reset-password.html',
    });
    if (error) alert("Error: " + error.message);
    else alert("Enlace de recuperaci√≥n enviado a " + email);
  }

  // FUNCI√ìN: Borrar cuenta (L√≥gica de seguridad)
  async function deleteAccount() {
    const confirmacion = confirm("¬øEST√ÅS TOTALMENTE SEGURO? Esta acci√≥n eliminar√° tu acceso a Zeletas Hub permanentemente.");
    if (confirmacion) {
        alert("Por seguridad de Supabase, para borrar la cuenta definitivamente debes contactar con soporte o usaremos una Edge Function. Procesando solicitud...");
        // Nota: El borrado de usuarios requiere permisos de Admin. Normalmente se marca el perfil como "inactivo".
    }
  }

  document.getElementById('logoutBtn').onclick = async () => {
    await supabaseClient.auth.signOut();
    window.location.href = "../index.html";
  };

  window.onload = cargarUsuario;
</script>
</body>
</html>
